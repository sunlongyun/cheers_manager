<header class="panel-heading">
  订单管理
</header>
<div class="panel-body">
  <form class="form-inline" id="form" role="form">
    <div class="form-group">
      <input type="text" class="form-control" name="orderNo" placeholder="订单编码">
    </div>
    <div class="form-group">
      <select class="form-control">
        <option value="-1">选择订单状态</option>
        <option value="0">下单待支付</option>
        <option value="1">买家已支付</option>
        <option value="2">买家已发货</option>
        <option value="3">买家已收货</option>
        <option value="4">订单已取消</option>
      </select>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="customerName" placeholder="顾客昵称">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="mobile" placeholder="手机号">
    </div>
    <button type="button" class="btn btn-primary" onclick="search()"><span class="glyphicon glyphicon-search"></span>&nbsp;查询
    </button>
  </form>
  <table id="table" class="text-center table table-bordered table-hover  table-striped"></table>
</div>
<script src="html/js/bootstrap-paginator.js" type="text/javascript"></script>
<script type="text/javascript">
  /**
   ** 查询
   **/
  function search() {
    /**
     ** 调用分页
     **/
    $("#table").search2('/admin/order/getPageInfo', 'form',
        [
          {"text": "订单号", "title": "orderNo"},
          {"text": "商品总价","format":function (obj) {
            var amount = obj.totalAmount;
            var html = amount;
            if(obj.status.code==0){
              html="<a href='javascript:modifyAmount("+obj.id+")' title='修改价格'>"+amount+"</span></a>";
            }
            return html;
            }},
          {"text": "商品进价", "title": "costAmount"},
          {"text": "邮费","format":function (obj) {
            var postage = obj.postage;
            var html = postage;
            if(obj.status.code==0){
              html="<a href='javascript:modifypPostage("+obj.id+")' title='修改邮费'>"+postage+"</span></a>";
            }
            return html;
          }},
          {"text": "物流单号", "format":function (obj) {
            if(obj.status.code == 0){
              return "--";
            }
            var content = obj.logisticsNumber;
            var opeHtml=content;
            if(obj.status.code == 2 || obj.status.code == 1){
              if(!content){
                content = "【去发货】";
              }
              opeHtml="<a href='javascript:send("+obj.id+")' title='物流单号'>"+content+"</span></a>";
            }

            return opeHtml;
            }},
          {"text": "支付流水号", "title": "payNo"},
          {"text": "支付金额", "title": "totalAmount"},
          {"text": "客户名称", "title": "customerName"},
          {"text": "联系方式", "title": "mobile"},
          {"text": "订单状态", "title": "status.value"},
          {"text": "创建时间", "title": "createTime"},
          {"text":"操作", "format":function (obj) {
              var opeHtml = '';
              if (obj.status.code == 0) {
                opeHtml += " <a href='javascript:void(0)'>[关闭]</a>";
              }
              opeHtml +="<a href='javascript:update("+obj.id+")' title='编辑'><span class='glyphicon glyphicon-edit'></span></a>";
              return opeHtml;
            }}
        ]
    );
  }

  search();

  //发货
  function send(orderId){
    var html = '<div class="form-group">' +
        '<label for="logisticsNumber" class="col-sm-3 control-label">物流单号:</label>' +
        '<div class="col-sm-7">' +
        '<input type="text" class="form-control" id="logisticsNumber" value="" placeholder="请填写物流单号">' +
        '</div>' +
        '</div>';

   $.dialog("发送填写物流单号", html, function () {
     var logisticsNumber = $("#logisticsNumber").val().trim();
     if (!logisticsNumber) {
       alert("物流单号不能为空");
       return false;
     }
     $.ajax({
       url: 'admin/order/updateOrder',
       type: 'post',
       dataType: 'json',
       contentType: 'application/json;charset=utf-8',
       data: JSON.stringify({
         "id":orderId,
         "logisticsNumber":logisticsNumber,
         "status":2
       }),
       success:function(res) {
         if (res.code == '0000') {
           $.dialogClose();
           search();
         }
       }
       })

    });
  }

  //添加
  function add() {
    var html = '<div class="form-group">' +
        '<label for="customerId" class="col-sm-3 control-label">选择客户:</label>' +
        '<div class="col-sm-7">' +
        '<input type="text" class="form-control" id="customerId" value="" placeholder="客户id(从客户列表粘贴)">' +
        '</div>' +
        '</div>';
    html += '<div class="form-group">' +
        '<label  class="col-sm-3 control-label">商品id:</label>' +
        '<div class="col-sm-7">' +
        '<input type="text" class="form-control" id="goodsId" value="" placeholder="从商品列表粘贴,多个商品用,隔开id">' +
        '</div>' +
        '</div>';
    html += '<div class="form-group">' +
        '<label  class="col-sm-3 control-label">商品数量:</label>' +
        '<div class="col-sm-7">' +
        '<input type="text"  class="form-control" id="goodsNum" value="" placeholder="和id对应的商品数量,多个商品用,隔开">' +
        '</div>' +
        '</div>';
    html += '<div class="form-group">' +
        '<label for="roomCards" class="col-sm-3 control-label">是否已支付:</label>' +
        '<div class="col-sm-7">' +
        '<input type="radio"  name="paySatus" value="0" checked="true">  未支付' +
        '&nbsp;&nbsp;<input type="radio"  name="paySatus" value="1" >  已支付' +
        '</div>' +
        '</div>';
    $.dialog("添加商品订单", html, function () {

      var customerId = $("#customerId").val().trim();
      var paySatus = $("input:checked[name='paySatus']").val().trim();
      var goodsIdList = $("#goodsId").val().trim();
      var goodsNumList = $("#goodsNum").val().trim();

      if (!customerId) {
        alert("客户id不能为空");
        return false;
      }
      if (!goodsIdList) {
        alert("商品ID列表空!");
        return false;
      }
      if (!goodsNumList) {
        alert("商品数量列表不能为空!");
        return false;
      }
      var goodsIdArr = goodsIdList.split(",");
      var goodsNumArr = goodsNumList.split(",");
      if (goodsIdArr.length != goodsNumArr.length) {
        alert("商品id和商品数量数目不相等!");
        return false;
      }
      var orderGoodsMappingList = [];
      for (var i = 0; i < goodsIdArr.length; i++) {
        var goodsId = goodsIdArr[i];
        var goodsNum = goodsNumArr[i];
        var goods = {};
        goods["goodsId"] = goodsId;
        goods["goodsNum"] = goodsNum;

        orderGoodsMappingList.push(goods);
      }

      $.ajax({
        url: '/order/save',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json;charset=utf-8',
        data: JSON.stringify({
          "customerId": customerId,
          "payStatus": paySatus,
          "orderGoodsMappingList": orderGoodsMappingList
        }),
        success: function (res) {
          if (res.code == '0000') {
            $.dialogClose();
            search();
          } else {
            alert("添加失败，请联系管理员");
          }
        }, error: function () {
          alert("添加失败");
        }
      });

    }, null, 180);

  }


  //编辑供应商
  function update(id) {
    var new_url =rootPath+"?id="+id;
    window.history.pushState(null, null, new_url)
    var url ="/updateSalesOrder";
    redirectTo(url);
  }

  /**
   * 修改商品价格
   */
  function modifyAmount(orderId){
    var html = '<div class="form-group">' +
        '<label for="totalAmount" class="col-sm-3 control-label">商品价格:</label>' +
        '<div class="col-sm-7">' +
        '<input type="number" class="form-control" id="totalAmount" min="1" value="" placeholder="请填写商品价格">' +
        '</div>' +
        '</div>';

    $.dialog("修改商品价格", html, function () {
      var totalAmount = $("#totalAmount").val().trim();
      if (!totalAmount) {
        alert("商品价格不能为空");
        return false;
      }
      var amount = parseInt(totalAmount)*100 ;
      $.ajax({
        url: 'admin/order/updateOrder',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json;charset=utf-8',
        data: JSON.stringify({
          "id":orderId,
          "totalAmount":amount
        }),
        success:function(res) {
          if (res.code == '0000') {
            $.dialogClose();
            search();
          }else{
            $.dialogClose();
            $.alert(res.msg);
          }
        }
      })

    });
  }

  //修改邮费
  function modifypPostage(orderId){
    var html = '<div class="form-group">' +
        '<label for="totalAmount" class="col-sm-3 control-label">邮费:</label>' +
        '<div class="col-sm-7">' +
        '<input type="number" class="form-control" id="postage" min="0" value="" placeholder="请填写邮费">' +
        '</div>' +
        '</div>';

    $.dialog("修改邮费", html, function () {
      var postage = $("#postage").val().trim();
      if (!postage) {
        alert("邮费不能为空");
        return false;
      }
      if(postage<0){
        alert("邮费不能小于0");
        return false;
      }
      var amount = parseInt(postage)*100 ;
      $.ajax({
        url: 'admin/order/updateOrder',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json;charset=utf-8',
        data: JSON.stringify({
          "id":orderId,
          "postage":amount
        }),
        success:function(res) {
          if (res.code == '0000') {
            $.dialogClose();
            search();
          }else{
            $.dialogClose();
            $.alert(res.msg);
          }
        }
      })

    });
  }
</script>
</body>
</html>